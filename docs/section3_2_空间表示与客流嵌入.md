# 3.1 数据收集与问题建模

## 3.1.3 问题建模

图神经网络的训练目标可归纳为三个层次，分别对应不同的研究尺度与任务需求：**图级别**关注整图特征的聚合与整体指标的预测，例如预测整条商业街或整个商场的总客流，适用于宏观绩效评估；**边级别**侧重判断节点间是否存在连接关系（如两空间是否可达），适用于拓扑结构的校验；**节点级别**则用于建模单个节点的属性与其真值之间的映射关系，例如预测某一空间单元的客流，适用于微观尺度的分析。本研究的核心问题是商业街（街巷）空间配置下的**公共空间客流效能**，即分析空间形态与拓扑结构对公共空间内客流分布的影响，建立“空间配置→人流量”的映射；在此设定下，**一个商业平面（一张空间图）对应一个训练单元**，若有多个商业平面则可构成多条样本，但实践中往往面临**空间数据有限**的问题——即可供训练的平面图或时间片数量不足，难以支撑直接在全图上做节点级预测的监督学习。现有研究多将时空数据联合建模；相比之下，采用**空间导向**的分析思路（a spatially oriented approach）更利于聚焦“空间配置如何影响客流”，与后续遗传算法等优化搜索的维度一致，但前提是克服“空间样本不足”的约束。

针对上述问题，本研究在问题转译中采用以下策略。**第一，子图增强与子图抽样（subgraph augmentation）**：不以整张图为单一样本，而是以每个有标签节点为中心抽取其**邻域子图**（如 2-hop 邻域）作为模型的输入单元；这样，一张图 × 多个有标签节点 × 多个时间片即可得到大量训练样本，从而在空间数据有限的前提下**放大有效训练样本数量**，使模型得以学习“以局部空间配置预测中心节点客流”的映射。**第二，强化节点特征**：单纯依赖拓扑结构信息往往不足以区分不同空间单元的客流差异，因此节点特征矩阵需包含丰富的空间与形态信息（如位置、形状特征、方向特征、沿街长度及拓扑中心性等，详见 3.2 节），使模型在邻域聚合之外更能利用单元自身属性。**第三，邻接关系的合理定义**：边表示空间单元之间的通达性，可根据**几何邻接**（相接、相交）或更符合行为语义的规则（如依据入口、开口关系）来定义邻接矩阵，而非仅依赖欧式距离，以更好反映行人实际可达路径。在此基础上，将每个空间单元抽象为图中的**节点**，有标签节点的**真实值**由历史客流观测经预处理与等级映射得到；通过图神经网络的**邻域信息聚合机制**，模型在图上同时刻画空间单元自身属性及其与邻域的交互关系，建立从**空间配置特征到客流效能**的映射。该问题转译方式既符合“空间单元—客流分布”的微观分析需求，又通过子图增强在有限空间数据下获得可训练的样本规模，为空间配置绩效预测及面向优化的可用性验证提供基础。

---

# 3.2 空间表示与客流嵌入

本节说明如何将商业街（街巷）空间表示为图结构、如何定义节点特征矩阵与边的连接关系，以及如何将客流观测嵌入到图中，为后续图神经网络预测提供统一的数据表达。

---

## 3.2.1 商业街空间的图结构表示

在图结构中，节点被抽象为空间单元，边表示空间单元之间的连通关系；每个节点附带一个特征矩阵用于描述其属性。研究将指定商业街范围内由平面矢量图（如街巷与店铺多边形）划分得到的空间组件抽象为图结构中的节点，并使用唯一 ID 进行编码，旨在最大限度地减少从平面几何到图结构表达转换过程中的信息丢失，使图结构能够反映实际的空间邻接与通达关系。与室内商场不同，商业街空间通常为二维平面（或可忽略高差），因此采用**平面图**表示；节点类型区分为**商业空间（店铺）**与**公共空间**两类，以支持异构图上的消息传递与客流预测。

---

## 街巷空间分割

街巷空间分割是图结构构建的前提。研究基于已有的平面矢量数据（如 GeoJSON 或 Shapefile）对商业街进行空间单元划分：

- **数据来源**：矢量数据可来自规划图纸的矢量化、开放地图数据的裁剪，或基于 2.x 节所述方法对街巷与店铺边界的提取与矫正。每个空间单元对应一个多边形，并带有功能属性（若存在）。
- **分割结果**：将所有多边形区分为两类——**商业空间（shop）**与**公共空间（public）**。商业空间对应沿街店铺或商业用地；公共空间对应街道、广场、绿地等可供公众通行的区域。若数据中仅有一种几何图层，可通过属性字段区分为 shop/public，或按约定将某一图层整体视为 public。
- **几何与拓扑**：在处理前需将矢量图形统一到**投影坐标系**（如以米为单位的平面坐标），以保证面积、周长、距离等计算以米制为单位，避免经纬度带来的度量误差。对空几何或无效几何进行剔除或 buffer(0) 修复，确保后续形状特征与邻接判断的稳定性。

上述分割得到的每个多边形即对应图中一个节点，其类型（shop/public）与几何将用于节点特征计算与边的构建。

---

## 节点矩阵表达

节点的特征矩阵需包含反映其实际空间与拓扑特征的指标。结合 2.3.1 节等相关理论基础，本研究从几何与拓扑两方面定义节点特征，并通过矢量数据计算得到。

### （1）基本属性与空间类型

每个节点具有**空间类型**属性：商业空间（shop）或公共空间（public）。该属性来源于街巷空间分割阶段的设定，用于异构图中的节点类型划分及边的语义区分。若存在功能细分字段（如餐饮、零售等），可编码为类别码；本研究图中主要使用 shop/public 二类。

### （2）空间位置

空间位置描述同一商业街范围内不同节点之间的相对位置关系。研究采用**平面直角坐标系**：以研究范围的中心或某一固定参考点为原点，正东为 x 轴正方向、正北为 y 轴正方向建立平面直角坐标系。基于此参考系，计算每个空间单元多边形的**质心**的米制 (x, y) 坐标，作为节点的位置特征。在三维扩展场景下可增加 z（如高程）；当前商业街平面图中使用二维坐标 (x, y)。

### （3）形状特征

形状特征用于描述空间单元的几何形状及轮廓复杂性，对行人的空间感知与步行体验有重要影响，需要体现长条形、方形、不规则等形态差异。基于相关研究，本研究采用以下四个指标表征形状：

- **紧凑度（Compactness，简称 Com）**：反映图形与圆形的接近程度，值越接近 1 表示形状越接近圆。

$$Com = \frac{4\pi A_b}{P_b^2} \quad \text{（3.3）}$$

- **延展性（Extensibility，简称 E）**：基于最小外接旋转矩形的长边与短边之比，值越大表示形状越狭长。

$$E = \frac{L_{sbr}}{W_{sbr}} \quad \text{（3.4）}$$

- **凹度（Concavity，简称 Con）**：反映边界内凹程度，值越接近 1 表示凹入越多。

$$Con = 1 - \frac{A_b}{A_{ch}} \quad \text{（3.5）}$$

- **轮廓复杂度（Fractal Degree，简称 FD）**：基于周长与面积的对数比，值越大表示轮廓越不规则。

$$FD = \frac{\log P_b}{\log A_b} \quad \text{（3.6）}$$

式中：$A_b$ 为几何图形面积，$P_b$ 为周长，$L_{sbr}$、$W_{sbr}$ 分别为最小外接旋转矩形的长边与短边，$A_{ch}$ 为凸包面积。上述指标均由矢量多边形的几何运算得到。

### （4）方向特征

方向特征描述空间单元的主要延展方向。街巷与店铺的延展方向往往不一致，不同方向的组合会影响通行与视线。对每个空间单元，先求其最小外接旋转矩形，取**长边方向**与参考方向（如正北）的夹角作为方向角；在模型中为避免周期断裂，将角度转换为**正弦、余弦**两维连续特征输入。

### （5）沿街长度

沿街长度描述空间单元与街道接触或自身轮廓的“可接触长度”，与行人可达性及店铺展示面相关。本研究以多边形的**周长**作为沿街长度（street_length）的度量；若后续有更精细的“临街边”定义，可替换为相应长度。

### （6）拓扑特征

为弥补图神经网络在整体图结构特征上的不足，在完成边的连接关系建立后，补充节点在图中的拓扑指标，使预测模型兼顾局部邻域与全局结构：

- **接近中心性（Closeness Centrality，CC）**：衡量节点到图中其余节点平均最短路径距离的倒数，反映可达性。

$$CC(u) = \frac{n-1}{\sum_{v \in V} d(u,v)} \quad \text{（3.7）}$$

其中 $n$ 为节点总数，$d(u,v)$ 为节点 $u$ 到 $v$ 的最短路径距离。

- **中介中心性（Betweenness Centrality，BC）**：衡量节点在所有最短路径上出现的频率，反映枢纽作用。

$$BC(u) = \sum_{s \neq u \neq t} \frac{\sigma_{st}(u)}{\sigma_{st}} \quad \text{（3.8）}$$

其中 $\sigma_{st}$ 为节点 $s$ 到 $t$ 的最短路径总数，$\sigma_{st}(u)$ 为经过节点 $u$ 的最短路径数。实现中采用无向图上的归一化形式。

### 特征归一化与矩阵形式

完成所有节点特征计算后，以**研究范围（或单条商业街）为单位**对连续特征进行 Z-score 归一化（减均值除标准差），以消除量纲差异并便于图神经网络训练。最终节点特征矩阵包含：**空间位置 (x, y)**、**形状特征 (Com, E, Con, FD)**、**方向 (main_axis 的 sin/cos 两维)**、**沿街长度 (street_length)**、**拓扑特征 (CC, BC)**，共 **11 维**连续向量。记录方式可如表 3-x 所示（示例列名与顺序可根据实现调整）。

| 列名 | 含义 | 说明 |
|------|------|------|
| node_id | 节点唯一标识 | 整数编码 |
| node_type | 空间类型 | shop / public |
| x, y | 质心坐标 | 米制，归一化前为原始坐标 |
| compactness | 紧凑度 | 式(3.3) |
| extensibility | 延展性 | 式(3.4) |
| concavity | 凹度 | 式(3.5) |
| fractal_degree | 轮廓复杂度 | 式(3.6) |
| street_length | 沿街长度 | 周长或临街边长 |
| main_axis_dir_deg | 主方向角 | 度，入模时转为 sin/cos |
| closeness | 接近中心性 | 式(3.7) |
| betweenness | 中介中心性 | 式(3.8) |

*表 3-x 节点特征矩阵列说明（表格来源：作者自制）*

---

## 图的构建与储存



### 单张图
0. 空间配置 -> 人流量 = 一个商业平面作为一个训练单元，多商业平面数据
1. 现有的研究多是结合时间
2. 空间导向的预测方法：Thus, a spatially oriented approach to urban data analysis is deemed more appropriate. 然而问题是，我并没有足够的空间数据来训练我的模型？
3. 解决方法如下（基于图构建）：
    a. subgraph augmentation 数据增强与子图抽样：抽取节点的领域子图作为模型的输入，从而放大训练样本数量
    b. 提升节点特征，单纯的拓扑结构信息可能太弱，必须依赖更丰富的节点特征。
    c. 根据入口开口来定义邻接矩阵而非简单的“欧式距离”
    d. Static Graph Learning: 利用历史客流数据、业务规则或外部特征，让模型自己发现哪些节点之间应该有连接，连接强度应该是多少。
4. 解决方法如下（基于图训练）：
    a. 使用自监督或者对比学习
    b. 

### 边的含义与构建原则

在图结构模型中，**边（Edge）**表示节点之间的连接关系。在商业街空间中，边表示空间单元之间的**通达性**：若两个空间在平面内相邻或可视为连通（如共边、相交或在一定距离内），则对应节点之间连一条无向边。

### 边连接规则

- **主规则——几何邻接**：对任意两个空间单元，若其多边形在几何上**相接（touches）**、**相交（intersects）**或**重叠（overlaps）**，则判定为邻接，在对应节点间建立一条无向边。使用空间索引（如 R-tree）进行候选筛选，再对候选对做精确几何判断，以提高计算效率。
- **补充规则——近邻补边**：为避免因矢量缝隙导致的孤立节点，可设定**质心距离阈值**：若两节点质心距离小于该阈值，则补充一条边。是否启用以及阈值大小可根据实际数据质量与连通性需求设定；仅用邻接时可关闭该补充。

### 边类型与异构图

商业街图中节点分为 **shop** 与 **public** 两类，边据此分为四类无向关系：**(shop, adj, shop)**、**(shop, adj, public)**、**(public, adj, shop)**、**(public, adj, public)**。在存储与模型前向时保留类型信息，以便异构图卷积对不同关系使用不同参数。若在优化或改造场景中需区分“是否对公众开放”，可在边表中增加 **open** 标记（例如仅含 public 端点的边为 open=1），用于构建时筛选。

### 储存格式

图结构以表格形式储存，便于与流式客流数据对接：

- **nodes.csv**：每行一个节点，列包括 node_id、node_type、x、y 及各形状、方向、沿街长度、拓扑特征列；可选 flow 列由后续流量数据写入或留空。
- **edges.csv**：每行一条边，列至少包括 src、dst（节点 ID）；若有 open 标记则增加 open 列。模型构建图时按 node_type 将边归类为上述四类。

坐标与连续特征在写入前可保持原始值，归一化在**构建图样本时**按已保存的均值/标准差进行，以保证训练与验证、测试阶段一致。客流数据按 (节点, 时间片) 写入 **flows.csv**，与节点、边表一起构成“空间表示与客流嵌入”的完整数据基础，供第四章图神经网络训练与评估使用。

---

*（本节内容与项目中 `geo/tool/build_nodes_edges.py`、`streetflow_hetero_time_gnn/geo/tool/build_graph.py` 的实现相对应；公式编号 3.3–3.8 与您提供的商场章节一致，便于与前文理论衔接。如需增加“图 3-xx 商业街空间图结构示意图”或“表 3-x 边类型与 open 标记对应表”，可在相应小节后插入并引用。）*



## Reference
1. Representation and assessment of spatial design