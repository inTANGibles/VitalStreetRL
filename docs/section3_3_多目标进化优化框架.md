# 3.3 多目标进化优化框架

本节阐述如何将街道活力提升问题表述为多目标优化问题，并采用进化算法（遗传算法）在决策空间内搜索 Pareto 前沿。框架包括：**决策变量与编码**（如何用基因组表示一次空间干预方案）、**适应度评估与目标函数**（如何从基因组得到活力、约束违反与成本等目标值）、**进化算子与终止准则**（如何通过选择、交叉、变异与修复保持可行解并逼近 Pareto 解集）。本节与项目中的 `vitalstreet_ga_optimization` 模块相对应，为第四章或后续“优化—预测”闭环提供方法基础。

---

## 3.3.1 决策变量与编码

多目标进化优化的**决策变量**即“一次空间干预方案”的形式化表示。本研究采用**无时序、按空间单元（节点）**的编码方式：将可改造的空间单元（如符合条件的商业空间）固定为一个有序列表，每个单元对应基因组中的一个**基因位**，基因取值表示“对该单元施加的干预类型”（含“不干预”）。该方式与“按时间步的动作序列”编码形成对照，更贴近“空间配置—绩效”的静态评估需求，且便于施加**每节点可行动作集合（mask）**与**全局预算约束**。

### （1）可改造节点与基因位

- **可改造节点**：仅对满足条件的**商业空间（shop）**单元视为可改造，且需满足**非保护（non-protected）**、**已启用（enabled）**等业务约束；具体是否允许“业态调整”或“改为公共空间”由数据与规则确定（如 replaceable、可参与 circulation 的 shop）。将所有可改造单元按**节点 ID 升序**排列，得到**可改造节点列表** $L = [u_1, u_2, \ldots, u_M]$，其中 $M$ 为可改造节点数量。
- **基因位与节点的一一对应**：基因组为长度 $M$ 的向量 $\mathbf{g} = (g_1, g_2, \ldots, g_M)$，其中 $g_i$ 对应节点 $u_i$ 的干预选择；$g_i \in \{0, 1, \ldots, N\}$，$0$ 表示**不干预（NO_OP）**，$1 \sim N$ 表示 $N$ 种具体干预类型（如业态调整至某类别、改为公共空间等）。

### （2）优化策略与更新策略的转译

动作类型由**优化策略**转译而来。优化策略包括：（1）**街区形态**——空间尺度与围合感（如街道宽高比 D/H 在 1–2 之间利于亲切、安全的停留与社交）；（2）**空间组织与空间动线**——合理布局与核心节点（广场、喷泉等）引导驻足，宽敞通透的通道促进浏览与消费转化；（3）**业态的时空协同效应**——不同业态在不同时段产生差异化的客流峰值，合理业态组合可平滑人流曲线、延长街道活跃时间，功能多样性（混合使用）是维持活力的关键（Hu et al., 2023）。将上述策略落实到可操作的**更新策略**，并对应到**编码表现**与 **action 类型**，如表 3-x 所示。

| 更新策略 | 目的 | 编码表现（矢量数据） | action 类型 |
|----------|------|----------------------|-------------|
| **业态置换** | 1）改变或增加与地方文化、消费者需求匹配的业态；2）构建互补型业态组合、降低同质竞争；3）提升停留时间与消费转化。 | 1. 以每个店铺 polygon 为单元编码：面积、门面长度、节点位（转角/入口/主街）、可见性 proxy。2. 业态类别：层级编码（大类/中类/细类）或 embedding。3. 约束标签：不可置换/可置换强度等级/保护与招商限制，用于 action mask。 | 选择目标店铺 $\mathrm{shop}_i$，选择新业态 $\mathrm{type}_j$（one-hot / embedding）。 |
| **街道打通与优化** | 1）提升连通性与可达性（渗透率、绕行系数下降）；2）改善客流分配与网络效率；3）消除断点、打通瓶颈、优化主次通达结构。 | 1. 仅以室外流通空间 polygon 作为流通层图的节点。2. 为“打通/封闭”预存可转译候选单元（店铺、中庭）的邻接与可改造标签（与流通空间是否相邻、共享界面/开口潜力）。3. 店铺作为另一层图，通过“入口—流通节点”映射与流通图层耦合。 | 1）店铺→公共空间；2）中庭→公共空间；3）公共空间→店铺/中庭。 |
| **公共空间改造** | 1）提升空间体验与停留性（舒适、安全、可识别）；2）通过空间复杂度与界面组织增强“感知吸引力”；3）改善公共空间与商业界面的耦合（导入、停驻、回游）。 | 1. 以公共空间 polygon 为单元编码：面积、最小净宽等级、主方向。2. 并存其邻接建筑单元列表（可扩宽候选）。3. 占用带候选（可收窄候选，含宽度等级与位置标签）。 | 收窄：选公共空间 + 几何缩放/几何简化。 |

### （3）动作类型与动作规格

- **动作类型**：由上表可见，**业态置换**对应“选店铺 $i$ + 新业态 $j$”（即 **change_business**）；**街道打通与优化**对应店铺→公共空间（**shop_to_public_space**）、中庭→公共空间、公共空间→店铺/中庭；**公共空间改造**对应收窄（选公共空间 + 几何缩放/简化）。当前实现中，**已支持**业态置换（change_business）与店铺→公共空间（shop_to_public_space）；中庭→公共空间、公共空间→店铺/中庭、公共空间收窄等类型在具备相应矢量编码与状态转移后可扩展为新的 action 类型。将所有“当前可用”的可选动作枚举为**动作规格列表** $\mathrm{spec}_1, \ldots, \mathrm{spec}_N$，则基因值 $k \in \{1,\ldots,N\}$ 表示对对应节点施加 $\mathrm{spec}_k$。
- **节点级可行域（mask）**：不同节点因属性不同，允许的动作子集不同（如表中的约束标签、可改造标签）。为每个基因位 $i$ 预计算**允许取值的集合** $\mathcal{M}_i \subseteq \{0,1,\ldots,N\}$，且 $0 \in \mathcal{M}_i$（不干预恒可行）。初始化与变异时，仅从 $\mathcal{M}_i$ 中采样，保证个体在**可行域**内。

### （4）全局预算约束

- **预算**：设全局允许的**最大改造节点数**为 $B$（即基因组中非零基因的个数不超过 $B$）。该约束在初始化、交叉与变异之后通过**修复算子（repair）**强制执行：若非零基因数大于 $B$，则按既定策略（如随机置零或按优先级置零）将超额基因位置为 $0$，使个体在进入适应度评估前**满足预算约束**，避免将可行域矛盾转化为目标函数惩罚。

### （5）从基因组到可执行动作

- **解码**：给定基因组 $\mathbf{g}$ 与可改造节点列表 $L$、动作规格列表，可得到**动作列表** $\{(u_i, a_i) : g_i \neq 0\}$，其中 $a_i$ 为与 $g_i$ 对应的动作（含类型与参数，如新业态类别）。
- **应用顺序**：将上述动作按**节点 ID 升序**依次施加到初始空间状态上，得到**干预后的状态**；状态转移逻辑（如业态更新、商业转公共空间及随之而来的流量重算）与 3.2 节空间表示及既有业务模块一致，此处仅规定“无时序、按节点顺序应用”，以保证评估的**确定性**与可复现性。

*（与实现对应：`encoding.py` 中的 `get_editable_nodes`、`build_action_specs`、`build_action_mask`、`random_genome`、`decode_to_actions`、`repair_budget`；`transition.py` 中的 `apply_actions_set`。`action_space.py` 中已按表 3-x 预留 ATRIUM_TO_PUBLIC_SPACE、PUBLIC_TO_SHOP、PUBLIC_NARROW 等枚举，当前仅实现 CHANGE_BUSINESS 与 SHOP_TO_PUBLIC_SPACE。）*

---

## 3.3.2 适应度评估与目标函数

**适应度评估**指从一条基因组得到多目标向量的过程：先解码为动作列表，再在初始状态上应用这些动作得到终态，最后根据终态与动作统计计算三个目标值。本研究采用**三目标最小化**形式，与 NSGA-II 等多目标进化算法直接对接。

### （1）状态转移与终态

- **初始状态**：来自 3.2 节的图结构及空间单元属性（含商业/公共类型、业态、是否可改造等）。
- **应用动作**：按 3.3.1 节得到的动作列表，依节点 ID 升序依次执行状态转移（业态更新、商业转公共空间及流量/复杂度重算等），得到**干预后状态**。
- **不引入时序**：同一“方案”内所有动作共享同一初始状态，无多步序贯决策；若需与序贯决策模型对比，可在讨论中说明编码差异。

### （2）三个目标函数（最小化）

- **目标一：最大化活力（最小化其相反数）**  
  活力指标基于公共空间面积与预测流量（或流量相关指标）的加权和；记终态活力为 $V_{\mathrm{final}}$，则第一目标为 $f_1 = -V_{\mathrm{final}}$，最小化 $f_1$ 即最大化活力。

- **目标二：最小化约束违反**  
  约束违反项衡量相对初始状态的**混合度下降、空置率上升、集中度上升**等恶化程度，记为 $f_2 = V_{\mathrm{viol}}$。最小化 $f_2$ 即尽量保持或改善原有约束指标。

- **目标三：最小化干预成本代理**  
  成本代理为改造动作的线性组合，例如 $f_3 = \alpha \cdot n_{\mathrm{public}} + \beta \cdot n_{\mathrm{business}}$，其中 $n_{\mathrm{public}}$ 为“商业转公共空间”次数，$n_{\mathrm{business}}$ 为“业态调整”次数；$\alpha$、$\beta$ 由配置给定。最小化 $f_3$ 即控制改造规模与类型。

上述三项构成目标向量 $\mathbf{f} = (f_1, f_2, f_3)$，算法在目标空间寻找**非支配（Pareto）解集**。

### （3）评估流程与接口

- **流程**：基因组 $\mathbf{g}$ → 解码为动作列表 → 在初始状态上应用动作得到终态 → 基于终态计算 $V_{\mathrm{final}}$、$V_{\mathrm{viol}}$，基于动作统计计算 $f_3$ → 输出 $\mathbf{f}$。
- **与既有模块的衔接**：活力与约束违反的计算依赖 3.2 节空间表示及既有奖励/指标模块（如 vitality_metrics、violation）；成本代理仅依赖动作统计。适应度评估函数通过**注入**状态转移函数与目标计算函数实现，不重写业务逻辑，仅做“编码—解码—应用—汇总”的封装。

*（与实现对应：`evaluator.evaluate_genome`、`transition.apply_actions_set`、以及由 reward/vitality_metrics 等构成的 objective_fn。）*

---

## 3.3.3 进化算子与终止准则

在保证**可行域（mask + 预算 B）**的前提下，通过选择、交叉、变异与修复维持种群多样性并逼近 Pareto 前沿；采用 NSGA-II 的**非支配排序与拥挤距离**进行选择，不重写 NSGA-II 框架本身。

### （1）初始化

- **合法采样**：每个个体通过**随机基因组**生成：对每位 $i$ 从 $\mathcal{M}_i$ 中均匀采样；生成后立即执行**预算修复**，使非零基因数 $\leq B$，从而保证初始种群可行。

### （2）交叉

- **均匀交叉**：对两个父代基因组，每位以相同概率（如 0.5）从父代一或父代二继承；得到两个子代。交叉后对每个子代执行**预算修复**，再进入下一阶段。

### （3）变异

- **按位重采样**：以概率 $p_m$（如 0.2）对每位从对应 mask $\mathcal{M}_i$ 中重新采样；其余位不变。变异后对个体执行**预算修复**，再进入评估。

### （4）修复（repair）

- **预算修复**：若基因组非零基因数大于 $B$，则按设定策略将多余非零位置为 $0$。策略可包括：**随机置零（random_drop）**、**按优先级置零（priority_drop）**等；修复在**初始化后、交叉与变异后**均执行，确保进入适应度评估的个体满足约束，而不依赖目标函数惩罚。

### （5）选择与算法框架

- **选择**：沿用 NSGA-II 的**非支配排序**与**拥挤距离**，在合并父代与子代后保留规模为 $N_{\mathrm{pop}}$ 的下一代；不重写 NSGA-II 的选择逻辑。
- **去重**：可选地在种群层面进行个体去重，以减少重复评估并促进多样性。

### （6）终止准则

- **代数终止**：当进化代数达到预设上限 $G_{\max}$ 时停止；输出当前种群（或当前 Pareto 前沿）作为结果。
- **其他准则**：若需可补充“超时”“Pareto 前沿变化小于阈值”等（实现中可按需扩展）。

*（与实现对应：`ga_nsga2.py` 中的 VitalStreetProblemNodewise、LegalGenomeSampling、NodewiseCrossover、NodewiseMutation、`_repair_population_nodewise`，以及 pymoo 的 NSGA2 与 minimize。）*

---

## 小结与与后文衔接

本节给出了**多目标进化优化框架**的完整链条：**决策变量与编码**（无时序、按节点的基因组与 mask、预算 B）→ **适应度评估与目标函数**（解码、应用、三目标最小化）→ **进化算子与终止准则**（合法初始化、均匀交叉、按位变异、预算修复、NSGA-II 选择与代数终止）。该框架与 3.2 节空间表示及既有活力/约束指标一致，为后续将“进化优化”与“图神经网络预测”或“活力—成本”权衡分析相结合提供统一方法基础。若后文需区分钟对“序贯动作序列”与“无时序节点级方案”的对比实验，可在此节末简要说明两种编码的差异及选用无时序编码的动机。

---

*（本节内容与项目中 `vitalstreet_ga_optimization` 的 encoding、evaluator、transition、ga_nsga2 及 configs/ga.yaml 中的 encoding_type、B、pm 等配置相对应。）*
