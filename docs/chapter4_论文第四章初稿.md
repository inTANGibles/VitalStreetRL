# 第四章 基于图神经网络的客流效能预测模型训练与评估

本章围绕基于异构时空图神经网络的公共空间客流预测模型，从数据集构建、模型结构、参数设定到性能评估与可用性验证，给出完整的实验设计与结果分析框架。

---

## 4.1 数据集构建与实验设计

### 4.1.1 数据来源与图结构

实验数据由街道网络与客流观测共同构成，主要包括三类表格数据：

- **节点表（nodes.csv）**：描述街道网络中的节点，节点类型分为商业节点（shop）与公共空间节点（public）。每个节点包含空间与形态学特征，包括平面坐标（x, y）、紧凑度（compactness）、可扩展性（extensibility）、凹度（concavity）、分形度（fractal_degree）、街道长度（street_length）、接近度（closeness）、介数（betweenness）以及主轴线方向角（main_axis_dir_deg）。其中主轴线方向以正弦、余弦两维表示【主轴方向角】，最终得到 **11 维连续空间特征**，不显式加入时间特征，以考察空间结构与邻域关系对客流的解释能力。

- **边表（edges.csv）**：描述节点间的邻接关系，支持按类型区分的无向边。图中共有四种边类型：商业–商业（shop–adj–shop）、商业–公共（shop–adj–public）、公共–商业（public–adj–shop）、公共–公共（public–adj–public），构成 **异构邻接结构**。

- **流量表（flows.csv）**：按（日期, 时段）或（日期, 时段槽 slot_idx）记录各 public 节点上的观测客流。时段粒度为 15 分钟，每日 20 个时段槽；实验中使用多日（如 11 天）数据，共 **220 个时间片**（11 × 20）。标签经预处理映射为 1–10 的客流等级（remap_1_10），仅对存在观测的 public 节点赋予标签。

节点特征在首次构建时按列计算均值与标准差，进行 **Z-score 标准化**，并将该 normalizer 保存后复用于所有时间片，保证训练/验证/测试阶段特征尺度一致。

### 4.1.2 样本构造与时间划分

为在保持时空覆盖的同时控制计算量，采用 **以有标签节点为中心的 2-hop 异构子图** 作为单样本：对每个时间片，对每个有流量观测的 public 节点提取以其为中心的 2 跳邻域子图（含 shop 与 public 节点及上述四类边），子图中心节点对应一个回归标签（1–10 等级）。因此，样本总数为「时间片数 × 有标签 public 节点数」，例如 220 × 20 = **4400** 个样本。

训练/验证划分 **按时间片索引划分**，避免同一时间片同时出现在训练与验证集中，从而更符合时序预测的设定。默认将时间片随机打乱后按 **80% 训练、20% 验证**（val_ratio=0.2），随机种子固定以保证可复现。验证集仅用于早停与超参数选择，不参与 normalizer 的拟合。

### 4.1.3 实验环境与评估指标

实验在 PyTorch 与 PyTorch Geometric 环境下实现，支持 CPU 与 GPU。模型训练采用 **L1 损失（MAE）** 作为优化目标；性能评估采用 **平均绝对误差（MAE）** 与 **均方根误差（RMSE）**，且仅在存在标签的节点上计算（mask 为真的样本）。上述设定与“客流等级”的回归任务相匹配，便于与后续基线及业务解释对接。

---

## 4.2 图神经网络模型结构

本节采用基于 **异构图 GraphSAGE（HeteroSAGE）** 的回归模型：在异构图上进行 2 层消息传递，并对 public 节点输出标量预测值（客流等级）。

### 4.2.1 模型整体架构

- **输入**：每个样本为一张异构子图，节点特征为 11 维（见 4.1.1），仅含空间与形态特征。
- **消息传递**：两层异构图卷积，每层对四种边类型（shop–shop、shop–public、public–shop、public–public）分别使用 SAGEConv，聚合方式为 **sum**；层间使用 ReLU 激活。
- **输出**：对 shop 与 public 节点各接一个线性层，映射到 1 维；**仅对 public 节点的中心节点** 计算损失与评估指标，即每个子图只监督中心节点的预测值。

该设计显式区分商业与公共空间节点类型，使模型能够学习“商业–公共”与“公共–公共”等不同关系对公共空间客流的影响。

### 4.2.2 参数设定

超参数通过 **Optuna** 在验证集 MAE 上进行贝叶斯优化，主要搜索空间为：

- **学习率（lr）**：对数均匀采样，范围 1e-4 ~ 1e-2；
- **隐藏维度（hidden_channels）**：在 {32, 64, 128} 中选取；
- **权重衰减（weight_decay）**：对数均匀采样，范围 1e-6 ~ 1e-2；
- **训练轮数（n_epochs）**：整数步长 20，范围 40 ~ 120。

优化目标为验证集 **MAE 最小**；采用 **MedianPruner** 进行早停以节省计算。最佳超参数保存至 `optuna_best_params.json`，正式训练时可加载该配置或在此基础上微调。默认输入维度为 11，输出维度为 1；若数据特征维度有变，需同步修改 `in_channels`。

---

## 4.3 客流预测性能评估

### 4.3.1 模型训练效果分析

训练过程中记录每轮训练损失与验证集 MAE/RMSE，并保存验证 MAE 最优的模型权重。可通过以下方式分析训练效果：

- **训练曲线**：绘制「轮次–训练损失」与「轮次–验证 MAE」曲线，观察收敛速度与过拟合情况；若使用 Optuna，可对比不同超参数下的曲线。
- **最优验证指标**：报告 best_val_mae 及对应 epoch，作为模型选择与后续对比的基准。
- **预测–真实散点图**：在验证集上对中心节点绘制预测值 vs 真实值散点图，观察偏差与分布；亦可按子图（同一中心节点不同时间片）聚合后绘图，以评估时序稳定性。
- **误差分布**：绘制验证集上误差（预测值 − 真实值）的直方图，用于检查系统性偏高/偏低或长尾现象。

上述结果可全部由当前流水线（如 `run_pipeline.py`）与可视化工具（如 `utils/viz.py`）自动生成并保存至指定目录。

### 4.3.2 模型预测效果分析（利用其他 baseline 对比）

为说明异构时序 GNN 的增益，可与多种基线进行对比，例如：

- **仅用节点特征的 MLP**：以中心节点 11 维特征为输入，相同标签与划分，训练 MLP 回归 1–10 等级，比较验证/测试 MAE、RMSE。预期本模型因利用邻域与异构图结构而优于 MLP。
- **同构 GNN（如 GCN/GAT）**：将 shop 与 public 视为同一类型节点，在相同图上训练 2 层 GCN 或 GAT，同样以中心节点预测值为监督。对比可体现“异构图建模”与“类型区分”的贡献。
- **时序基线（如历史均值、简单 RNN）**：若引入时间特征或时序模型，可增加与历史均值、滑动平均或简单 RNN 的对比，以说明图结构与时序建模的联合效果。

建议在相同数据划分、相同评估指标（MAE/RMSE）与相同标签变换（remap_1_10）下进行对比，并报告均值与标准差（若有多随机种子或多种划分）。

### 4.3.3 解释性分析

可从以下角度对模型进行解释性分析，以支撑“为何该节点预测高/低”的讨论：

- **子图结构**：分析高/低预测对应的 2-hop 子图在节点数、边数、shop/public 比例上的差异，或统计与中心节点直接相连的 commercial 节点数对预测值的影响。
- **邻域贡献**：通过消融或特征掩码，观察仅用中心节点特征、仅 1-hop、完整 2-hop 时 MAE 变化，以量化“邻域信息”的贡献。
- **高级可解释方法**：若需更细粒度解释，可引入基于注意力的边权重可视化（若将 SAGE 换为 GAT 或加入注意力）、或基于梯度的节点/边重要性（如 saliency、integrated gradients），对典型高误差或高价值节点进行案例解读。

当前代码未内置上述可解释性模块，可在现有前向与评估流程上扩展，并单独成节或小节呈现。

### 4.3.4 面向优化的可用性验证

为验证模型在“空间优化”场景下的可用性，设计了 **shop 改 public** 的虚拟实验：将某个商业节点视为改为公共空间（即将其类型从 shop 改为 public，并加入 public 节点集合），在原图上重新构建子图并前向传播，得到该“新 public 节点”的预测客流等级。该流程对应代码中的 `shop_to_public` 与 `predict_shop_converted_to_public`，可用于：

- **选址与改造评估**：比较不同 shop 改为 public 后的预测客流，为“哪处商业空间改为公共空间更有利于整体客流”提供量化依据。
- **与真实 public 节点对比**：将虚拟改造节点的预测值与现有 public 节点在同一时间片下的预测值对比，评估改造后的相对吸引力。

可视化和日志可输出该子图结构、中心节点标识及预测客流，便于写入报告或作为决策支持的可解释输出。该部分可直接作为“面向优化的可用性验证”的实证内容。

---

## 小结

第四章给出了基于图神经网络的客流效能预测从数据到评估的完整流程：4.1 明确了数据集构成、11 维空间特征、异构边类型、时间片与子图样本构造以及按时间划分的实验设计；4.2 描述了 HeteroSAGE 的 2 层异构图卷积与回归头结构，以及基于 Optuna 的超参数设定；4.3 从训练效果、与 baseline 的对比、解释性分析以及面向 shop→public 优化的可用性验证四方面，给出了性能评估与落地应用的写作框架。您可根据实际跑出的数值与图表对上述各小节进行填充与精简，并在需要时提出具体技术问题（如特征含义、损失设计、基线实现细节等），可再逐条细化或补充公式与算法伪代码。
