# 新地点、新数据 — 可视化所需数据准备说明

换新地点、新数据时，需要按下列清单准备数据，并保证**字段名与格式**与代码一致（或相应改代码）。

---

## 一、必须准备的数据（5 类）

### 1. WiFi 探针流水数据（轨迹与流量分析的数据源）

**用途**：个人/总体轨迹、流量分布等。  
**格式**：JSON Lines（每行一条 JSON）。

**每条记录必须包含：**

| 字段 | 含义 | 类型 | 示例 |
|------|------|------|------|
| `m` | 设备标识（如 MAC 的字节表示） | 列表，可哈希以区分设备 | `[96,18,60,48,247,160]` |
| `a` | 探针/AP 编号（与 `devices_axis` 一致） | 数字 | `208` |
| `t` | 时间戳（秒，Unix 时间） | 数字 | `1703484025` |

**示例一行：**
```json
{"_id":{"$oid":"6588ad9dc6ab114fb26d23f9"},"m":[96,18,60,48,247,160],"a":208,"r":161,"t":1703484025}
```

**说明：**
- 代码用 `pd.read_json(f, lines=True)` 读取，再 `pd.to_datetime(df['t'], unit='s')` 转时间。
- 若你的时间是日期时间字符串，需在代码里改成 `pd.to_datetime(df['t'])` 等。
- 探针编号 `a` 必须与下面 **探针坐标**、**最短路径** 中的编号一致。

**建议存放**：如 `final_data/你的数据_日期.json`。

---

### 2. 探针/设备坐标 `devices_axis.json`

**用途**：轨迹上的“点”落在哪里、标注探针号、停留点位置。  
**格式**：单个 JSON 对象。

**结构：**  
`"探针编号": [x坐标, y坐标]`  
探针编号建议用字符串（代码中会 `str(device)` 做匹配）。

**示例：**
```json
{
    "207": [23.0, 48.0],
    "220": [29.0, 13.0],
    "204": [14.0, 47.0]
}
```

**要求：**
- 所有在 WiFi 数据里出现的 `a`，都应在此有对应项。
- 坐标需与底图、`points_axis` 使用**同一坐标系**（见下文“底图与坐标”）。

---

### 3. 路径节点坐标 `points_axis.json`

**用途**：两探针之间“最短路径”由一系列**途经点**组成，这些点的坐标从这里取。  
**格式**：单个 JSON 对象。

**结构：**  
`"节点编号": [x坐标, y坐标]`  
节点编号通常为字符串（代码用 `axis_df.at[str(pass_point), 0]` 取 x，`1` 取 y）。

**示例：**
```json
{
    "91": [25.0, 16.0],
    "81": [37.0, 42.0],
    "66": [34.0, 39.0]
}
```

**要求：**
- `devices_shortest_path.json` 里所有出现的**途经点**（含探针编号若当节点用），都需在 `points_axis.json` 中有对应坐标。

---

### 4. 设备间最短路径 `devices_shortest_path.json`

**用途**：轨迹还原时，相邻两探针之间不画直线，而是画“路径上的途经点”连成的折线。  
**格式**：单个 JSON 对象。

**结构：**  
- **key**：字符串形式的元组 `"(探针A, 探针B)"`，且为**排序后**的 (小, 大)，与代码中 `tuple(sorted((a1,a2)))` 一致。  
- **value**：`[最短距离, 途经点ID列表]`  
  - 第 0 个元素：路径长度（可浮点）。  
  - 第 1 个元素：从探针 A 到探针 B 依次经过的**节点/探针 ID** 列表（顺序重要），这些 ID 必须在 `points_axis.json` 中存在。

**示例：**
```json
{
    "(209, 206)": [14.0, [209, 66, 79, 81, 80, 206]],
    "(205, 210)": [18.0, [205, 38, 80, 42, 76, 210]]
}
```

**要求：**
- 若 WiFi 数据中会出现探针对 (a1, a2)，则 `(min(a1,a2), max(a1,a2))` 应在此有 key，否则该段轨迹无法画出。
- 途经点列表中的每个 ID，都必须在 `points_axis.json` 中有对应项。

**如何得到该文件：**  
一般由“图 + 最短路径算法”离线算好：用节点/边表示走廊、道路等，节点对应 `points_axis` 中的点，探针对应部分节点，再对每对探针跑最短路径并导出途经点。

---

### 5. 底图（总平面图）

**用途**：2D 轨迹图、流量分布图等的背景。  
**格式**：图片文件（如 `.jpg`、`.png`）。

**代码中的用法示例：**
```python
img_path = r"总平面图2.jpg"
x_min, x_max = 1.8, 50   # 与你的坐标系一致
y_min, y_max = 3, 60
img = Image.open(img_path)
ax.imshow(img, extent=[x_min, x_max, y_min, y_max], aspect='auto', alpha=0.3)
```

**要求：**
- `devices_axis.json` 和 `points_axis.json` 的坐标必须与 `extent=[x_min, x_max, y_min, y_max]` 使用**同一坐标系**（即底图在 Photoshop / GIS 中配准到该坐标范围）。
- 新地点需重新配准底图并修改代码中的 `x_min, x_max, y_min, y_max` 和 `img_path`。

---

## 二、数据关系小结

```
WiFi 流水 (m, a, t)
    ↓ 按时间排序得到 探针序列 (a1, a2, ...)
    ↓ 相邻探针对 (a1,a2) → 查 devices_shortest_path
devices_shortest_path["(a1,a2)"][1] → 途经点 ID 列表
    ↓ 每个 ID 查 points_axis
points_axis[id] → (x,y) 画轨迹折线

devices_axis[探针号] → 探针在地图上的位置、标注、停留点
底图 extent + 上述坐标 → 同一坐标系下叠图
```

- **探针编号**：在 WiFi 的 `a`、`devices_axis`、`devices_shortest_path` 的 key 中要一致。  
- **节点/途经点 ID**：在 `devices_shortest_path` 的 value 列表与 `points_axis` 中要一致。  
- **坐标系统一**：`devices_axis`、`points_axis`、底图 `extent` 三者一致。

---

## 三、换新地点/新数据时在代码里要改的地方

1. **路径与文件名**
   - 所有 `import_data()`、`import_shortest_path_data()`、`import_node_axis_data()`、`import_devices_axis_data()` 中的 `data_path`。
   - 底图的 `img_path`。

2. **时间范围与时间格式**
   - 若仍用 Unix 秒：保持 `pd.to_datetime(df['t'], unit='s')`。
   - 若用字符串：改为 `pd.to_datetime(df['t'])` 或指定 `format=`。
   - 筛选时间段的 `start_time` / `end_time`（如 `'2023-12-25 07:00:00'`）按新数据修改。

3. **底图与坐标范围**
   - `x_min, x_max, y_min, y_max` 改成新底图配准后的范围，与 `devices_axis`、`points_axis` 一致。

4. **WiFi 字段名**
   - 若你的列名不是 `m` / `a` / `t`，要么把数据改成 `m/a/t`，要么在代码里统一 `df.rename(columns={...})`。

---

## 四、最小可运行集合（仅做轨迹/流量）

- **必选**：WiFi 流水 JSON Lines、`devices_axis.json`、`points_axis.json`、`devices_shortest_path.json`、底图 + 坐标范围。  
- **可选**：若只做“探针间直线连接”的简化版轨迹，可以暂时不实现最短路径，仅用 `devices_axis` 两点连线（需改绘图逻辑，且与当前“沿路径还原”不一致）。

按上述准备后，只需在脚本中替换路径、时间范围和底图范围即可在新地点用新数据做 2D/3D 轨迹与流量可视化。
