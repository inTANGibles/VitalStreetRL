# StreetFlow Hetero Time GNN

Single-plot heterogeneous graph (shop / public) + time-conditioned pedestrian flow prediction (masked node regression). PyTorch Geometric, no external data download; demo data is generated by script.

## 0) Directory layout

```
streetflow_hetero_time_gnn/
  README.md
  data/street.geojson                       # 统一 GeoJSON 数据源（含 unit_type: shop/public_space）
  notebooks/01_pipeline_visualization.ipynb   # Full pipeline visualization (run top to bottom)
  geo/tool/build_graph.py                     # CSV → normalized features + time feat → HeteroData per time slice
  data/dataset.py                             # TimeSliceDataset (train/val by time slice)
  models/hetero_sage.py                       # Hetero GraphSAGE, 2 layers, regression per node type
  train.py                                    # Train → checkpoints/best.pt, outputs/train_log.json
  predict.py                                  # Inference
  utils/metrics.py                            # MAE / RMSE
  utils/seed.py                               # Fixed random seed
  utils/viz.py                                # Plot: graph, features, time, pred vs true, error, GA sensitivity
  scripts/make_demo_csv.py                    # Generate data_demo/nodes.csv, edges.csv, flows.csv (42 time slices)
  scripts/optuna_tune.py                      # Optuna hyperparameter search (lr, hidden_channels, weight_decay, n_epochs)
  geo/tool/build_nodes_edges.py               # From street.geojson → nodes.csv, edges.csv (same logic as VitalStreetRL)
  notebooks/build_graph.ipynb                # Build graph from street.geojson (mirror VitalStreetRL notebook)
  checkpoints/                                # best.pt, normalizer.json
  outputs/                                    # train_log.json, predictions.csv
  data_demo/                                  # Demo CSVs (generated or user-provided)
```

## 1) Task

- **Nodes**: two types — `shop` (e.g. 75), `public` (e.g. 25). Only `public` has flow labels.
- **Edges**: undirected; all edges participate in message passing.
- **Time**: 42 slices = 7 days × 6 hours (12–17). Same graph structure and geometry; labels and time features vary by slice.
- **Target**: predict flow on public nodes (default label = `log1p(flow)`); output also `yhat_flow = expm1(yhat_log)`.

## 2) CSV format

- **nodes.csv**: `node_id`, `node_type` (shop|public), `x`, `y`, `compactness`, `extensibility`, `concavity`, `fractal_degree`, `street_length`, `closeness`, `betweenness`, `main_axis_dir_deg`
- **edges.csv**: `src`, `dst`, `open`. 所有相邻图块边都列出；`open=1` 当且仅当两端至少有一个为 public_space。构建图时仅使用 `open=1` 的边；GA 将 shop 改为 public 时从同一 edge 表构建子图（会包含与转换节点相连的边）。
- **flows.csv** (optional):
  - 整图模式：`node_id`, `day` (0–6), `hour`, `flow`
  - 15 分钟子图模式：`node_id`, `day`, `slot_idx` (0–19), `flow`（1–10 等级）

## 2b) 15 分钟时间片 + 2-hop 子图模式（4400 样本）

- **时间片**：12–17 时，每 15 分钟，20 slot/天 × 11 天 = 220 片
- **客流**：从 `data/FlowData/Jul/Flow/clean_*.json` 生成，15 分钟去重，Box-Cox + 线性映射 1–10
- **子图**：以有标签节点为中心的 2-hop 异构子图
- **样本数**：220 × 20 有标签节点 = 4400

```bash
# 1) 生成 15 分钟 flows.csv（需 geopandas, shapely）
python geo/tool/build_flow_15min.py \
  --flow_dir ../data/FlowData/Jul/Flow \
  --devices ../data/FlowData/Jul/Axis/devices_axis.json \
  --street data/street.geojson \
  --nodes data_demo/nodes.csv \
  --out data_demo/flows.csv

# 2) 训练子图模型
python train.py --subgraph --use_slot
```

## 3) Run from 0 to 1

**方式 A：用 data/street.geojson（项目内统一数据源）**

```bash
cd streetflow_hetero_time_gnn
# street.geojson 位于 data/street.geojson
python geo/tool/build_nodes_edges.py --geojson data/street.geojson --out_dir data_demo --flows_csv
# 然后打开 notebooks/build_graph.ipynb 检查图，再训练
python train.py
```

**方式 B：用脚本生成 demo 数据**

```bash
cd streetflow_hetero_time_gnn

# 1) Generate demo data
python scripts/make_demo_csv.py

# 2) Train (saves checkpoints/best.pt, outputs/train_log.json)
python train.py

# 3) Open and run the full pipeline + plots in the notebook
jupyter notebook notebooks/01_pipeline_visualization.ipynb

# 4) Inference for a given (day, hour)
python predict.py
```

To run inference from command line with day/hour, add CLI to `predict.py` or call from notebook as in `01_pipeline_visualization.ipynb`.

## 4) Inference

- **predict.py**  
  - `predict(...)`: given `data_dir`, `checkpoint_dir`, `output_dir`, `day`, `hour`.  
  - Writes `outputs/predictions.csv`: `node_id`, `node_type`, `yhat_log`, `yhat_flow`.

## 5) Notebook contents (01_pipeline_visualization.ipynb)

- **A** Generate demo data; show CSV head and N_shop, N_public, edge count, time slice count.
- **B** Build one HeteroData (e.g. day=0, hour=12); print node/edge counts; plot graph (node type colors); plot 11 continuous features before/after z-score; plot time features over 42 slices.
- **C** Build 42-slice dataset; plot labeled public count per slice; sample 3 slices and plot log1p(flow) distribution.
- **D** Train (e.g. 200 epochs); plot train loss and val MAE; pred vs true scatter; error histogram on val.
- **E** Run predict for one (day, hour); plot nodes by yhat_flow (colorbar); print public prediction sum.
- **F** （已移除）GA edge open/close sensitivity.

All plotting is in `utils/viz.py` (matplotlib). No external data; data comes from `scripts/make_demo_csv.py` or your own CSVs in `data_demo/`.
